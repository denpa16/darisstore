ARG PACKAGES_IMAGE
FROM ${PACKAGES_IMAGE:-npm_packages} AS BUILDER

FROM node:20.13-alpine

ARG NPM_TOKEN
ENV NPM_TOKEN=$NPM_TOKEN
ARG NPM_REGISTRY
ENV NPM_REGISTRY=$NPM_REGISTRY
ARG IMGPROXY_SITE_HOST
ENV IMGPROXY_SITE_HOST=$IMGPROXY_SITE_HOST
ARG UI_DEMO
ENV UI_DEMO=$UI_DEMO
ARG SERVER_API_URL
ENV SERVER_API_URL=$SERVER_API_URL
ARG REDIS_DSN
ENV REDIS_DSN=$REDIS_DSN
ARG SENTRY_DSN_FRONTEND
ENV SENTRY_DSN_FRONTEND=$SENTRY_DSN_FRONTEND
ARG SENTRY_DSN_NUXT_FRONTEND
ENV SENTRY_DSN_NUXT_FRONTEND=$SENTRY_DSN_NUXT_FRONTEND
ARG SENTRY_ENVIRONMENT
ENV SENTRY_ENVIRONMENT=$SENTRY_ENVIRONMENT
ARG SMARTCAPTCHA_CLIENT_KEY
ENV SMARTCAPTCHA_CLIENT_KEY=$SMARTCAPTCHA_CLIENT_KEY

WORKDIR /app
COPY --from=BUILDER /app/node_modules /app/node_modules/
COPY / /app/
RUN chmod +x entrypoint.production.sh
RUN npm set "//$NPM_REGISTRY/:_authToken=$NPM_TOKEN"
RUN npm run build
