.before_script_docker_login: &before_script_docker_login
  echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

.before_script_configure_ssh: &before_script_configure_ssh |
  which ssh-agent || ( apk --update add openssh-client )
  eval $(ssh-agent -s)
  echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  mkdir -p ~/.ssh
  chmod 700 ~/.ssh
  ssh-keyscan "$DEPLOY_HOST" >> ~/.ssh/known_hosts
  chmod 644 ~/.ssh/known_hosts
  [[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config


deploy:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(main|develop)$/
  environment:
    name: ${CI_COMMIT_REF_SLUG}
    url: ${ENVIRONMENT_URL}
  variables:
    DOCKER_HOST: ssh://$DEPLOY_USER@$DEPLOY_HOST
    PROJECT_NAME: ${CI_PROJECT_NAME}
    SERVER_NAME: ${CI_PROJECT_NAME}
    CADVISOR_URL: ${CADVISOR_URL}
    IMGPROXY_URL: ${IMGPROXY_URL}
    AGENT_URL: ${AGENT_URL}
    BRANCH_NAME: ${CI_COMMIT_REF_SLUG}
  before_script:
    - *before_script_configure_ssh
    - *before_script_docker_login
  script:
    - TAG=${CI_COMMIT_REF_SLUG} docker compose -f docker-compose.yml -f docker-compose.frontend.yml -f docker-compose.production.yml -f docker-compose.monitoring.yml pull
    - docker stop $(docker ps -aq) || true
    - TAG=${CI_COMMIT_REF_SLUG} docker compose -f docker-compose.yml -f docker-compose.frontend.yml -f docker-compose.production.yml -f docker-compose.monitoring.yml up --remove-orphans -d
