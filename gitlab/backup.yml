.before_script_docker_login: &before_script_docker_login
  echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

.before_script_configure_ssh: &before_script_configure_ssh |
  which ssh-agent || ( apk --update add openssh-client )
  eval $(ssh-agent -s)
  echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  mkdir -p ~/.ssh
  chmod 700 ~/.ssh
  ssh-keyscan "$DEPLOY_HOST" >> ~/.ssh/known_hosts
  chmod 644 ~/.ssh/known_hosts
  [[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

backup:db:
  stage: backup
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual
      allow_failure: true
  environment:
    name: ${CI_COMMIT_REF_SLUG}
    url: ${ENVIRONMENT_URL}
  variables:
    DOCKER_HOST: ssh://$DEPLOY_USER@$DEPLOY_HOST
  before_script:
    - *before_script_configure_ssh
    - *before_script_docker_login
  script:
    - >
      docker compose -f docker-compose.yml -f docker-compose.production.yml exec -T db
      sh -c "pg_dumpall -c -U postgres > ~/dump_db_`date +%d-%m-%Y"_"%H_%M_%S`.sql"
